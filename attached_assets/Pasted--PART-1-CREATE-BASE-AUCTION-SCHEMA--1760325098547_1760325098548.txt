========================
-- PART 1: CREATE BASE AUCTION SCHEMA
-- ===================================================================

-- Create auction status enum
CREATE TYPE IF NOT EXISTS auction_status AS ENUM ('draft', 'upcoming', 'active', 'ended', 'cancelled');

-- Create auctions table
CREATE TABLE IF NOT EXISTS public.auctions (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT,
  place TEXT,
  title TEXT NOT NULL,
  description TEXT,
  starting_price INTEGER NOT NULL,
  current_bid INTEGER,
  reserve_price INTEGER,
  image_url TEXT,
  image_urls TEXT[],
  category TEXT,
  start_date TIMESTAMPTZ NOT NULL,
  end_date TIMESTAMPTZ NOT NULL,
  created_by TEXT NOT NULL,
  status auction_status DEFAULT 'draft',
  winner_id TEXT,
  payment_completed BOOLEAN DEFAULT FALSE,
  payment_intent_id TEXT,
  payment_completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Create bids table
CREATE TABLE IF NOT EXISTS public.bids (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  auction_id TEXT,
  auction_item_id TEXT,
  user_id TEXT NOT NULL,
  bid_amount INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Create auction_items table
CREATE TABLE IF NOT EXISTS public.auction_items (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  auction_id TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  starting_price INTEGER NOT NULL,
  current_bid INTEGER,
  reserve_price INTEGER,
  image_url TEXT,
  image_urls TEXT[],
  position INTEGER DEFAULT 0,
  winner_id TEXT,
  payment_completed BOOLEAN DEFAULT FALSE,
  payment_intent_id TEXT,
  payment_completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_auctions_status ON public.auctions(status);
CREATE INDEX IF NOT EXISTS idx_auctions_end_date ON public.auctions(end_date);
CREATE INDEX IF NOT EXISTS idx_auctions_created_by ON public.auctions(created_by);
CREATE INDEX IF NOT EXISTS idx_auction_items_auction_id ON public.auction_items(auction_id);
CREATE INDEX IF NOT EXISTS idx_auction_items_winner ON public.auction_items(winner_id);
CREATE INDEX IF NOT EXISTS idx_bids_auction_id ON public.bids(auction_id);
CREATE INDEX IF NOT EXISTS idx_bids_auction_item_id ON public.bids(auction_item_id);
CREATE INDEX IF NOT EXISTS idx_bids_user_id ON public.bids(user_id);

-- ===================================================================
-- PART 2: ENABLE ROW LEVEL SECURITY (RLS)
-- ===================================================================

ALTER TABLE public.auctions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.auction_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bids ENABLE ROW LEVEL SECURITY;

-- Auction policies
CREATE POLICY "Anyone can view active auctions" 
  ON public.auctions FOR SELECT 
  USING (status IN ('active', 'upcoming', 'ended'));

CREATE POLICY "Users can view their own auctions" 
  ON public.auctions FOR SELECT 
  USING (auth.uid()::text = created_by);

CREATE POLICY "Users can create auctions" 
  ON public.auctions FOR INSERT 
  WITH CHECK (auth.uid()::text = created_by);

CREATE POLICY "Users can update their own auctions" 
  ON public.auctions FOR UPDATE 
  USING (auth.uid()::text = created_by);

-- Auction items policies
CREATE POLICY "Anyone can view active auction items"
  ON public.auction_items FOR SELECT
  USING (
    auction_id IN (
      SELECT id::text FROM public.auctions 
      WHERE status IN ('active', 'upcoming', 'ended')
    )
  );

CREATE POLICY "Auction creators can manage items"
  ON public.auction_items FOR ALL
  USING (
    auction_id IN (
      SELECT id::text FROM public.auctions WHERE created_by = auth.uid()::text
    )
  );

CREATE POLICY "Winners can view their won items"
  ON public.auction_items FOR SELECT
  USING (winner_id = auth.uid()::text);

-- Bid policies
CREATE POLICY "Anyone can view bids on active auctions" 
  ON public.bids FOR SELECT 
  USING (
    EXISTS (
      SELECT 1 FROM public.auctions 
      WHERE auctions.id::text = bids.auction_id 
      AND auctions.status IN ('active', 'ended')
    )
  );

CREATE POLICY "Authenticated users can place bids" 
  ON public.bids FOR INSERT 
  WITH CHECK (auth.uid()::text = user_id);

-- ===================================================================
-- PART 3: CREATE TRIGGER TO UPDATE current_bid
-- ===================================================================

-- Function to update auction_items current_bid when bid placed
CREATE OR REPLACE FUNCTION update_auction_item_current_bid()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.auction_item_id IS NOT NULL THEN
    UPDATE public.auction_items
    SET current_bid = NEW.bid_amount,
        updated_at = NOW()
    WHERE id::text = NEW.auction_item_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to automatically update current_bid when bid placed
CREATE TRIGGER on_new_bid_update_item
  AFTER INSERT ON public.bids
  FOR EACH ROW
  EXECUTE FUNCTION update_auction_item_current_bid();

-- ===================================================================
-- PART 4: CREATE TEST DATA
-- ===================================================================

-- Get your user ID
DO $$
DECLARE
  user_id TEXT;
  auction1_id TEXT;
  auction2_id TEXT;
  now_ts TIMESTAMPTZ := NOW();
BEGIN
  -- Get first user ID
  SELECT id::text INTO user_id FROM auth.users LIMIT 1;
  
  IF user_id IS NULL THEN
    RAISE EXCEPTION 'No users found. Please sign up first.';
  END IF;

  -- Create Auction 1
  INSERT INTO public.auctions (
    name, place, title, starting_price, category,
    start_date, end_date, created_by, status
  ) VALUES (
    'Spring Estate Sale 2025',
    'Los Angeles, CA',
    'Spring Estate Sale Container',
    0,
    'collectibles',
    now_ts,
    now_ts + INTERVAL '2 hours',
    user_id,
    'active'
  ) RETURNING id::text INTO auction1_id;

  -- Add items to Auction 1
  INSERT INTO public.auction_items (auction_id, title, description, starting_price, image_url, position) VALUES
    (auction1_id, 'Vintage Rolex Watch', 'Classic timepiece', 500000, 'https://images.unsplash.com/photo-1587836374828-4dbafa94cf0e?w=400', 1),
    (auction1_id, 'Antique Persian Rug', 'Hand-woven masterpiece', 300000, 'https://images.unsplash.com/photo-1600166898405-da9535204843?w=400', 2),
    (auction1_id, 'Victorian Oil Painting', 'Beautiful floral art', 150000, 'https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?w=400', 3),
    (auction1_id, 'Antique Mahogany Desk', 'Elegant furniture piece', 200000, 'https://images.unsplash.com/photo-1518455027359-f3f8164ba6bd?w=400', 4);

  -- Create Auction 2
  INSERT INTO public.auctions (
    name, place, title, starting_price, category,
    start_date, end_date, created_by, status
  ) VALUES (
    'Vintage Electronics Auction',
    'San Francisco, CA',
    'Vintage Electronics Container',
    0,
    'electronics',
    now_ts,
    now_ts + INTERVAL '2 hours',
    user_id,
    'active'
  ) RETURNING id::text INTO auction2_id;

  -- Add items to Auction 2
  INSERT INTO public.auction_items (auction_id, title, description, starting_price, image_url, position) VALUES
    (auction2_id, 'Apple Macintosh 128K', 'Original 1984 computer', 250000, 'https://images.unsplash.com/photo-1603302576837-37561b2e2302?w=400', 1),
    (auction2_id, 'Sony Walkman TPS-L2', 'First portable cassette player', 80000, 'https://images.unsplash.com/photo-1615876234886-fd9a39fda97f?w=400', 2),
    (auction2_id, 'Atari 2600 Console', 'Classic gaming system', 50000, 'https://images.unsplash.com/photo-1558584673-c834fb1cc3ca?w=400', 3),
    (auction2_id, 'Vintage Polaroid SX-70', 'Instant camera icon', 40000, 'https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?w=400', 4),
    (auction2_id, 'Nintendo Game Boy', 'Handheld gaming legend', 30000, 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400', 5);

END $$;
```